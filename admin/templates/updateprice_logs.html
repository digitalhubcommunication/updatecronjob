{% extends "base.html" %}

{% block title %}Update Price Logs{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto mt-10 bg-white p-6 rounded-xl shadow">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-center">Update Price Logs</h2>
        <form method="POST" action="{{ url_for('clear_updateprice_logs') }}" onsubmit="return confirm('Are you sure you want to delete all logs?')">
            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                üóëÔ∏è Clear All Logs
            </button>
        </form>
    </div>

    <div class="flex justify-between items-center mb-4">
        <input type="text" id="searchInput" placeholder="Search logs..." class="w-64 px-4 py-2 border rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
        <div class="text-sm text-gray-500">Showing <span id="logCount"></span> logs</div>
    </div>

    <div class="overflow-x-auto">
        <table id="logsTable" class="min-w-full border text-sm text-gray-700">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 border">#</th>
                    <th class="px-4 py-2 border">Cron Job ID</th>
                    <th class="px-4 py-2 border">URL</th>
                    <th class="px-4 py-2 border">Status</th>
                    <th class="px-4 py-2 border">Time (s)</th>
                    <th class="px-4 py-2 border">Result</th>
                    <th class="px-4 py-2 border">Logged At</th>
                </tr>
            </thead>
            <tbody id="logTableBody">
                {% for log in logs %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 border">{{ loop.index }}</td>
                    <td class="px-4 py-2 border">{{ log['cron_job_id'] }}</td>
                    <td class="px-4 py-2 border break-words max-w-xs">{{ log['url'] }}</td>
                    <td class="px-4 py-2 border">
                        {% if log['status_code'] >= 200 and log['status_code'] < 300 %}
                            <span class="text-green-600 font-semibold">{{ log['status_code'] }}</span>
                        {% elif log['status_code'] == 0 %}
                            <span class="text-red-600 font-semibold">Error</span>
                        {% else %}
                            <span class="text-yellow-600 font-semibold">{{ log['status_code'] }}</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-2 border text-center">{{ log['response_time'] }}</td>
                    <td class="px-4 py-2 border break-all max-w-md text-xs text-gray-600">{{ log['result'] }}</td>
                    <td class="px-4 py-2 border text-gray-500 text-xs">{{ log['ran_at'] or '‚Äî' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="flex justify-center mt-6 space-x-2">
        <button onclick="prevPage()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Previous</button>
        <button onclick="nextPage()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Next</button>
    </div>
</div>

<script>
    const rowsPerPage = 10;
    let currentPage = 1;
    const table = document.getElementById("logsTable");
    const tbody = document.getElementById("logTableBody");
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const logCount = document.getElementById("logCount");

    function displayRows() {
        const search = document.getElementById("searchInput").value.toLowerCase();
        let visibleRows = rows.filter(row => row.innerText.toLowerCase().includes(search));
        logCount.textContent = visibleRows.length;

        rows.forEach(row => row.style.display = "none");

        const start = (currentPage - 1) * rowsPerPage;
        const paginated = visibleRows.slice(start, start + rowsPerPage);

        paginated.forEach(row => row.style.display = "");
    }

    function nextPage() {
        const search = document.getElementById("searchInput").value.toLowerCase();
        const visibleRows = rows.filter(row => row.innerText.toLowerCase().includes(search));
        if (currentPage * rowsPerPage < visibleRows.length) {
            currentPage++;
            displayRows();
        }
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            displayRows();
        }
    }

    document.getElementById("searchInput").addEventListener("input", () => {
        currentPage = 1;
        displayRows();
    });

    window.addEventListener("load", () => {
        displayRows();
    });
</script>
{% endblock %}
